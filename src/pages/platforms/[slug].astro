---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import "../../styles/global.css";
import hubs from "../../data/platform-hubs.json";

export const prerender = true;

type Hub = {
  title: string;
  contextPlatformKey: "pc" | "xbox" | "playstation" | "switch" | "mobile";
  intro: string[];
  gameSlugs: string[];
};

export async function getStaticPaths() {
  const hubMap = hubs as Record<string, Hub>;
  return Object.entries(hubMap).map(([slug, hub]) => ({
    params: { slug },
    props: { hub },
  }));
}

const { slug } = Astro.params;
const { hub } = Astro.props as { hub: Hub };

const games = (await getCollection("games"))
  .filter((entry) => !entry.data.exclude && hub.gameSlugs.includes(entry.slug));

const title = hub.title;
const description = hub.intro?.[0] || `${hub.title} platform hub`;
---
<SiteLayout title={title} description={description}>
  <a class="text-sm text-[var(--brand-blue)] font-semibold" href="/platforms">‚Üê All platforms</a>
  <header class="mt-2 mb-6">
    <p class="text-xs uppercase tracking-[0.15em] text-slate-500">Context: {hub.contextPlatformKey.toUpperCase()}</p>
    <h1 class="text-3xl font-bold text-[var(--brand-slate)]">{title}</h1>
    <div class="space-y-2 mt-3">
      {hub.intro.map((line) => <p class="text-slate-600">{line}</p>)}
    </div>
  </header>

  {games.length === 0 ? (
    <p class="text-slate-600">No games are curated for this hub yet.</p>
  ) : (
    <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
      {games.map((g) => (
        <li class="border border-slate-100 rounded-2xl p-4 bg-white shadow-sm hover:shadow-md transition">
          <a
            class="block"
            href={`/games/${g.slug}`}
            data-umami-event="game-card-click"
            data-umami-event-game={g.slug}
            data-umami-event-source={`platform-${slug}`}
          >
            {g.data.coverImage ? (
              <img
                src={g.data.coverImage}
                alt={`${g.data.title} cover`}
                class="rounded-xl mb-3 aspect-[16/9] object-cover"
                loading="lazy"
              />
            ) : (
              <div class="mb-3 bg-slate-100 aspect-[16/9] rounded-xl grid place-items-center text-slate-400 text-sm">
                No image
              </div>
            )}
            <h2 class="text-lg font-semibold text-[var(--brand-slate)]">{g.data.title}</h2>
            {g.data.short && (
              <p class="text-sm text-slate-600 mt-1 line-clamp-2">
                {g.data.short}
              </p>
            )}
            {g.data.tesla?.available
              ? <p class="mt-2 text-xs text-emerald-700">Available in Tesla Arcade</p>
              : <p class="mt-2 text-xs text-slate-500">Home/portable only</p>}
          </a>
        </li>
      ))}
    </ul>
  )}
</SiteLayout>
