---
import type { CollectionEntry } from "astro:content";
import { gameAffiliateLinks, affiliates } from "../lib/affiliates";

const { entry } = Astro.props as { entry: CollectionEntry<"games"> };
const { Content } = await entry.render?.() ?? { Content: null };

// Build store links from slug (digital stores)
let storeLinks: {label: string; url: string; store: string}[] = [];
try {
  const raw = (await gameAffiliateLinks(entry.slug)) || [];
  const seen = new Set<string>();
  storeLinks = raw
    .filter((l) => l?.url)
    .filter((l) => {
      if (seen.has(l.url)) return false;
      seen.add(l.url);
      return true;
    })
    .map((l) => ({ label: l.label, url: l.url, store: l.store }));
} catch {
  storeLinks = [];
}

const P = entry.data.platforms;
const yn = (v?: boolean) => (v ? "Yes" : "No");
const list = (a?: string[]) => (a && a.length ? a.join(", ") : "—");

const plat = [
  { label: "Tesla (in-car)",       available: entry.data.tesla.available,       perks: list(entry.data.tesla.notes) },
  { label: "PC",          available: P.pc.available,                    perks: list(P.pc.perks) },
  { label: "Xbox",        available: P.xbox.available,                  perks: list(P.xbox.perks) },
  { label: "PlayStation", available: P.playstation.available,           perks: list(P.playstation.perks) },
  { label: "Switch",      available: P.switch.available,                perks: list(P.switch.perks) },
  { label: "Mobile (iOS/iPad + Android)",      available: P.mobile.available,                perks: list(P.mobile.perks) },
];

const pickStoreUrl = (preferred: string[]): string | undefined => {
  for (const id of preferred) {
    const match = storeLinks.find((l) => l.store === id);
    if (match?.url) return match.url;
  }
  return storeLinks[0]?.url;
};

const platformContexts = [
  {
    key: "pc-handheld",
    available: P.pc.available,
    title: "PC handheld (Steam Deck / handheld PC)",
    summary: "Best for your portable PC library and fastest updates.",
    bullets: P.pc.perks.length ? P.pc.perks : [
      "Uses your Steam/PC library",
      "Runs well on Steam Deck and handheld PCs",
    ],
    hub: "/platforms/steam-deck/",
    ctaUrl: pickStoreUrl(["gmg","steam","gog","humble","epic","ms"]),
  },
  {
    key: "switch",
    available: P.switch.available,
    title: "Switch (and Switch 2)",
    summary: "Best for handheld-first sleep/resume play; Switch 2 sits under the same umbrella.",
    bullets: P.switch.perks.length ? P.switch.perks : [
      "Instant sleep/resume",
      "Consistent controls for portable play",
    ],
    hub: "/platforms/switch/",
    ctaUrl: pickStoreUrl(["amazon-switch"]),
  },
  {
    key: "mobile",
    available: P.mobile.available,
    title: "Mobile (iOS/iPad + Android)",
    summary: "Best when you want no-console, on-the-go play.",
    bullets: P.mobile.perks.length ? P.mobile.perks : [
      "iOS (iPhone/iPad) + Android support",
      "Touch-friendly options",
    ],
    hub: undefined,
    ctaUrl: pickStoreUrl(["amazon-switch"]),
  },
  {
    key: "tesla",
    available: entry.data.tesla?.available,
    title: "Tesla (in-car)",
    summary: "Best for in-car play between stops.",
    bullets: entry.data.tesla?.notes?.length ? entry.data.tesla.notes : [
      "Availability varies by hardware, software, and region.",
    ],
    hub: undefined,
    ctaUrl: undefined,
  },
].filter((c) => c.available);
---

<section class="space-y-8">
  <!-- 1) DESCRIPTION -->
  <header class="space-y-4">
    {entry.data.coverImage && (
      <img src={entry.data.coverImage} alt={`${entry.data.title} title art`} class="rounded-xl" loading="lazy" />
    )}
    <div>
      <h1 class="text-3xl font-bold">{entry.data.title}</h1>
      {entry.data.short && <p class="text-slate-600 mt-2">{entry.data.short}</p>}
    </div>
    {Content && <div class="prose prose-slate max-w-none"><Content /></div>}
  </header>

  <!-- 2) PLATFORMS -->
  <section class="space-y-3">
    <h2 class="text-xl font-semibold">Mobile Platforms</h2>
    {platformContexts.length === 0 ? (
      <p class="text-slate-600">No portable contexts available for this title.</p>
    ) : (
      <section class="grid gap-4 md:grid-cols-2">
        {platformContexts.map((ctx) => (
          <div class="p-4 border border-slate-200 rounded-xl bg-white shadow-sm space-y-2">
            <h3 class="text-lg font-semibold text-[var(--brand-slate)]">{ctx.title}</h3>
            <p class="text-sm text-slate-600">{ctx.summary}</p>
            {ctx.bullets?.length > 0 && (
              <ul class="list-disc ml-6 text-sm text-slate-700">
                {ctx.bullets.slice(0, 3).map((perk) => <li>{perk}</li>)}
              </ul>
            )}
            {ctx.hub && (
              <p class="text-sm font-semibold text-[var(--brand-blue)]">
                <a href={ctx.hub}>View {ctx.title.split(" ")[0]} hub →</a>
              </p>
            )}
            {ctx.ctaUrl && (
              <p>
                <a
                  href={ctx.ctaUrl}
                  target="_blank"
                  rel="noopener noreferrer sponsored"
                  class="text-sm font-semibold text-[var(--brand-blue)] underline"
                  data-umami-event="affiliate-click"
                  data-umami-event-game={entry.slug}
                  data-umami-event-store="platform-context"
                >
                  Where to buy →
                </a>
              </p>
            )}
          </div>
        ))}
      </section>
    )}
  </section>

  <!-- 3) WHERE TO BUY -->
  {storeLinks.length > 0 && (
    <section class="space-y-3">
      <h2 class="text-xl font-semibold">Where to buy / play at home</h2>
      <div class="p-4 border rounded-xl bg-white">
        <ul class="list-disc ml-6">
          {storeLinks.map((l) => (
            <li>
              <a
                href={l.url}
                target="_blank"
                rel="noopener noreferrer sponsored"
                data-umami-event="affiliate-click"
                data-umami-event-game={entry.slug}
                data-umami-event-store={l.store}
              >
                {l.label}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </section>
  )}

  <!-- 4) PLATFORM COMPARISON AT A GLANCE -->
  <section class="space-y-3">
    <h2 class="text-xl font-semibold">Platform comparison at a glance</h2>
    <div class="overflow-x-auto p-0 md:p-0">
      <table class="w-full text-sm border rounded-xl overflow-hidden bg-white">
        <thead class="bg-slate-50 text-slate-700">
          <tr><th class="text-left p-3">Platform</th><th class="text-left p-3">Available</th><th class="text-left p-3">Key perks / differences</th></tr>
        </thead>
        <tbody>
          {plat.map((p) => (
            <tr class="border-t">
              <td class="p-3 font-medium">{p.label}</td>
              <td class="p-3">{p.available ? "Yes" : "No"}</td>
              <td class="p-3">{p.perks}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- 3) CROSS-SAVES -->
  <section class="p-4 border rounded-xl">
    <h2 class="text-xl font-semibold mb-2">Cross-save & travel progress</h2>
    <ul class="list-disc ml-6">
      <li>Tesla → home export supported: {yn(entry.data.saves.teslaExportSupported)}</li>
      {entry.data.saves.crossSaveNotes.map(n => <li>{n}</li>)}
    </ul>
  </section>

  <!-- 4) FEATURES -->
  <section class="p-4 border rounded-xl">
    <h2 class="text-xl font-semibold mb-2">Features & inputs</h2>
    <ul class="list-disc ml-6">
      <li>Local co-op: {yn(entry.data.features.localCoop)}</li>
      <li>Online co-op (native): {yn(entry.data.features.onlineCoopNative)}</li>
      {entry.data.features.onlineCoopWorkaround.length > 0 && (
        <li>Online workaround: {entry.data.features.onlineCoopWorkaround.join(", ")}</li>
      )}
      <li>Controller recommended: {yn(entry.data.features.controllerRecommended)}</li>
    </ul>
  </section>

  <!-- OPTIONAL HARDWARE -->
  {entry.data.recommendedHardware.length > 0 && (
    <section class="p-4 border rounded-xl">
      <h2 class="text-xl font-semibold mb-2">Recommended hardware</h2>
      <ul class="list-disc ml-6">
        {entry.data.recommendedHardware.map((key) => (
          <li>
            <a
              class="underline"
              href={affiliates.amazon(key)}
              target="_blank"
              rel="noopener noreferrer sponsored nofollow"
              data-umami-event="affiliate-click"
              data-umami-event-game={entry.slug}
              data-umami-event-store="amazon"
            >
              {key.replaceAll("_"," ")}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- 5) NOTES -->
  {entry.data.notes.length > 0 && (
    <section class="p-4 border rounded-xl">
      <h2 class="text-xl font-semibold mb-2">Notes</h2>
      <ul class="list-disc ml-6">
        {entry.data.notes.map(n => <li>{n}</li>)}
      </ul>
    </section>
  )}
</section>
